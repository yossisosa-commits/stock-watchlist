<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>רשימת מעקב מניות v8</title>
<style>
:root{
--bg:#0b1020; --card:#0f162b; --muted:#9aa6b2; --txt:#e7edf3;
--line:#203055; --accent:#4da3ff; --ok:#19c37d; --bad:#ff5a5f; --warn:#f2a900;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:20;background:rgba(11,16,32,.9);border-bottom:1px solid var(--line);backdrop-filter:blur(8px)}
.wrap{max-width:1200px;margin-inline:auto}
.header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:12px 16px}
h1{margin:0;font-size:18px}
.controls{margin-inline-start:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,textarea,button{background:#0b1328;border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:8px 10px}
input,select,textarea{outline:none}
button{cursor:pointer}
button.primary{background:#2563eb;border-color:#2563eb}
main{padding:16px}
.card{background:linear-gradient(180deg,#0f162b,#0d1426);border:1px solid var(--line);border-radius:16px;padding:14px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.k{background:#0b1328;border:1px solid var(--line);border-radius:12px;padding:10px}
.k .l{font-size:11px;color:var(--muted)} .k .v{margin-top:4px;font-weight:600}
.grid{display:grid;grid-template-columns:3fr 2fr;gap:16px}
@media(max-width:1024px){.grid{grid-template-columns:1fr}}
.form h3{margin:0 0 8px 0}
.form .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.tablewrap{overflow:auto}
table{min-width:960px;width:100%;border-collapse:collapse;table-layout:fixed}
th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center;vertical-align:top}
th{position:sticky;top:72px;z-index:5;background:#0f162b;color:var(--muted);font-size:12px}
th:nth-child(1),td:nth-child(1){width:90px}
th:nth-child(2),td:nth-child(2){width:220px;text-align:start}
th:nth-child(3),td:nth-child(3){width:110px}
th:nth-child(4),td:nth-child(4){width:120px}
th:nth-child(5),td:nth-child(5){width:130px}
th:nth-child(6),td:nth-child(6){width:120px}
th:nth-child(7),td:nth-child(7){width:240px}
th:nth-child(8),td:nth-child(8){width:170px}
th:nth-child(9),td:nth-child(9){width:150px}
a{color:var(--accent);text-decoration:none}
.nameCell{cursor:pointer}
.hint{font-size:12px;color:var(--muted)}
.chg.pos{color:var(--ok)} .chg.neg{color:var(--bad)}
.status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.bad{color:var(--bad)}
textarea{min-height:56px;resize:vertical;width:100%}
.row-actions{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
canvas.spark{width:140px;height:36px;display:block;margin:auto}
.drawer{position:fixed;inset-block:0;inset-inline-end:-520px;width:min(520px,100%);background:#0f162b;border-inline-start:1px solid var(--line);transition:inset-inline-end .25s ease;z-index:40;display:flex;flex-direction:column}
.drawer.open{inset-inline-end:0}
.drawer header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
.drawer .content{padding:12px;overflow:auto}
.section{margin-top:10px}
.section h4{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.badges{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1328}
.toast{position:fixed;inset-block-end:16px;inset-inline-start:16px;background:#0b1328;border:1px solid var(--line);padding:10px 12px;border-radius:12px;font-size:12px;display:none;z-index:50}
</style>
</head>
<body>
<header>
<div class="wrap header">
<h1>רשימת מעקב מניות</h1>
<div class="controls">
<input id="searchInput" placeholder="חיפוש סימול או שם"/>
<button id="sortChangeBtn">מיין שינוי</button>
<label class="hint">תדירות שניות <input id="intervalInput" type="number" min="5" step="1" value="10" style="width:72px;direction:ltr"></label>
<button id="applyIntervalBtn">החל</button>
<button id="refreshBtn">רענון</button>
<button id="exportBtn">יצוא</button>
<label for="importFile" style="display:inline-flex;gap:6px;cursor:pointer">יבוא
<input id="importFile" type="file" accept="application/json" style="display:none">
</label>
<input id="avKey" placeholder="Alpha Vantage API Key" style="width:260px"/>
<button id="notifyBtn" class="primary">הפעל התרעות</button>
</div>
</div>
</header>

<main class="wrap">
<div class="kpis">
<div class="k"><div class="l">סהכ מניות</div><div class="v" id="kCount">0</div></div>
<div class="k"><div class="l">חציות פעילות</div><div class="v" id="kAlerts">0</div></div>
<div class="k"><div class="l">עודכן בהצלחה</div><div class="v" id="kLastOk">-</div></div>
<div class="k"><div class="l">סטטוס מערכת</div><div class="v" id="kStatus">מוכן</div></div>
</div>

<div class="grid">
<div class="card tablewrap">
<table>
<thead>
<tr>
<th>סימול</th><th>שם</th><th>מחיר</th><th>שינוי</th><th>שווי שוק</th>
<th>סטטוס</th><th>הערות</th><th>מיני גרף</th><th>פעולות</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
<p class="hint">טיפ: לחיצה על שם החברה או על כל השורה תפתח כרטיס מידע מפורט בצד. קישור ל-Yahoo נמצא על הסימול בלבד.</p>
</div>

<div class="card form">
<h3>הוספת מניה</h3>
<div class="row">
<label>סימול <input id="symbolInput" placeholder="NVDA, MSFT, AAPL"></label>
<label>שם ידידותי (uppercase אוטומטי) <input id="nameInput" placeholder="לא חובה"></label>
</div>
<div class="row3">
<label>סף עליון <input id="upperInput" type="number" step="0.01" placeholder="לא חובה"></label>
<label>סף תחתון <input id="lowerInput" type="number" step="0.01" placeholder="לא חובה"></label>
<label>סוג סף
<select id="thresholdType">
<option value="price">מחיר</option>
<option value="percent">אחוז יומי</option>
</select>
</label>
</div>
<label>הערה <textarea id="noteInput" placeholder="למה המניה ברשימה, טריגרים, רעיונות"></textarea></label>
<button id="addBtn" class="primary">הוסף לרשימה</button>
<p class="hint">נתוני Alpha Vantage. כדי לא להיחסם: רענון 10-15 שניות, עד 20-30 סמלים. פרטי חברה נמשכים כל כמה דקות ונשמרים במטמון.</p>
</div>
</div>
</main>

<!-- Drawer -->
<aside class="drawer" id="drawer">
<header>
<div id="drawerTitle">מידע</div>
<button id="drawerClose">סגור</button>
</header>
<div class="content">
<div class="badges" id="dBadges"></div>
<div class="section">
<h4>תקציר חברה</h4>
<div id="dSummary" class="hint" style="line-height:1.6"></div>
</div>
<div class="section">
<h4>מפתחי פרופיל</h4>
<div class="kv hint" id="dProfile"></div>
</div>
<div class="section">
<h4>מכפילים ונתונים</h4>
<div class="kv hint" id="dFinancials"></div>
</div>
<div class="section">
<h4>דוחות ותחזיות</h4>
<div class="hint" id="dEarnings"></div>
</div>
</div>
</aside>

<div class="toast" id="toast"></div>
<audio id="beep" preload="auto"><source type="audio/wav" src="data:audio/wav;base64,UklGRl4AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAAEAAAAD//wAA//8AAP//AAD//wAA"></audio>

<script>
(function(){
// ============ קבועים ומצב ============
const LS='wl.v8', LS_AV='wl.avkey';
let REFRESH=10000; // 10s כדי לא לחרוג
const DETAILS_MS=300000; // 5 דקות לפרטי חברה
let timer=null, lastOk=null, lastErr=null;

let state = load() || { items:[], prices:{}, details:{}, spark:{} };

const $=id=>document.getElementById(id);
const el={
tbody:$('tbody'), add:$('addBtn'), sym:$('symbolInput'), name:$('nameInput'),
upper:$('upperInput'), lower:$('lowerInput'), th:$('thresholdType'), note:$('noteInput'),
refresh:$('refreshBtn'), sort:$('sortChangeBtn'), s:$('searchInput'),
interval:$('intervalInput'), apply:$('applyIntervalBtn'),
kCount:$('kCount'), kAlerts:$('kAlerts'), kLastOk:$('kLastOk'), kStatus:$('kStatus'),
exportBtn:$('exportBtn'), importFile:$('importFile'), notify:$('notifyBtn'),
avKey:$('avKey'), toast:$('toast'), beep:$('beep'),
drawer:$('drawer'), dClose:$('drawerClose'), dTitle:$('drawerTitle'),
dBadges:$('dBadges'), dSummary:$('dSummary'), dProfile:$('dProfile'),
dFinancials:$('dFinancials'), dEarnings:$('dEarnings')
};

// ============ עזר ============
function save(){ localStorage.setItem(LS, JSON.stringify(state)) }
function load(){ try{ return JSON.parse(localStorage.getItem(LS)) }catch{return null} }
const fmt=(n,dp=2)=> (n==null||isNaN(n)) ? '-' : Number(n).toLocaleString('en-US',{maximumFractionDigits:dp});
function cap(n){ if(!n||n<=0) return '-'; const u=[['T',1e12],['B',1e9],['M',1e6]]; for(const[s,v] of u){ if(n>=v) return (n/v).toFixed(2)+s } return fmt(n,0) }
const now=()=> new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
const esc=t=>t? t.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])):'';
function toast(m){ el.toast.textContent=m; el.toast.style.display='block'; clearTimeout(el.toast._t); el.toast._t=setTimeout(()=>el.toast.style.display='none',2000) }

// ============ Alpha Vantage rate limit ידידותי ============
const RATE={perMin:25, gap:3000}; let q=[], busy=false, winStart=0, winCount=0;
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
async function avFetch(url){
return new Promise((resolve,reject)=>{ q.push({url,resolve,reject}); pump() });
}
async function pump(){
if(busy) return; busy=true;
try{
while(q.length){
const nowMs=Date.now();
if(nowMs - winStart >= 60000){ winStart=nowMs; winCount=0 }
if(winCount >= RATE.perMin){ await sleep(60000 - (nowMs - winStart) + 25); continue }
const job=q.shift();
try{
const r=await fetch(job.url, {cache:'no-store'});
if(!r.ok) throw new Error('HTTP '+r.status);
const j=await r.json();
winCount++; await sleep(RATE.gap);
job.resolve(j);
}catch(e){ job.reject(e) }
}
} finally { busy=false }
}

// ============ מקור נתונים יחיד: Alpha Vantage ============
const AV={ q:(sym,key)=>`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(key)}`,
ov:(sym,key)=>`https://www.alphavantage.co/query?function=OVERVIEW&symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(key)}` };

// סיבוב סמלים בכל טיק בשביל המגבלה
let rot=0;
function pickSymbols(){
const all=state.items.map(x=>x.symbol);
const MAX=5; // עד 5 סמלים בכל טיק
if(all.length<=MAX) return all;
const end=Math.min(rot+MAX, all.length);
const part=all.slice(rot,end);
rot = (end===all.length) ? 0 : end;
return part;
}

async function fetchPrices(symbols){
const key=(el.avKey.value || localStorage.getItem(LS_AV) || '').trim();
if(!key){ lastErr='חסר API Key'; el.kStatus.textContent='חסר API Key'; return false }
const syms = symbols && symbols.length ? symbols : pickSymbols();
if(!syms.length) return false;
let anyOk=false;
for(const sym of syms){
try{
const j=await avFetch(AV.q(sym,key));
const d=j['Global Quote']||{};
const price=Number(d['05. price']);
const open=Number(d['02. open']);
const chg=Number(d['09. change']);
const chgp=parseFloat((d['10. change percent']||'').replace('%',''));
state.prices[sym]={symbol:sym,shortName:sym,regularMarketPrice:price,
regularMarketChange: isFinite(chg)?chg:(isFinite(price-open)?price-open:0),
regularMarketChangePercent: isFinite(chgp)?chgp:(isFinite(price-open)&&open?((price-open)/open*100):0),
marketCap:null};
pushSpark(sym, price);
anyOk=true;
}catch(e){ lastErr='AV '+e.message }
}
if(anyOk){ lastOk=now(); save() }
return anyOk;
}

async function fetchOverview(symbols){
const key=(el.avKey.value || localStorage.getItem(LS_AV) || '').trim();
if(!key) return;
const list = symbols && symbols.length ? symbols : state.items.map(x=>x.symbol);
for(const sym of list){
const d = state.details[sym]; if(d && Date.now()-d._ts<DETAILS_MS) continue;
try{
const j=await avFetch(AV.ov(sym,key));
state.details[sym]={
_ts:Date.now(),
profile:{ longBusinessSummary:j.Description||'', sector:j.Sector||'', industry:j.Industry||'' },
stats:{ trailingPE: num(j.PERatio), forwardPE:num(j.ForwardPE), beta:num(j.Beta) },
fin:{ totalRevenue:num(j.RevenueTTM), dividendYield: num(j.DividendYield), analystTarget: num(j.AnalystTargetPrice) },
earn:{ lastQ: { date:j.LatestQuarter||'', actual:num(j.EPS), estimate:null, surpriseText:null } },
nextEarnings: j.LatestQuarter || ''
};
save();
}catch(e){ lastErr='AV '+e.message }
await sleep(250);
}
}
function num(x){ const n=Number(x); return isFinite(n)?n:null }

// ============ גרפים והתראות ============
function pushSpark(sym,p){ if(!isFinite(p)) return; const a=state.spark[sym]||[]; a.push(+p); while(a.length>150)a.shift(); state.spark[sym]=a }
function drawSpark(cv,pts){ if(!cv) return; const c=cv.getContext('2d'), w=cv.width, h=cv.height; c.clearRect(0,0,w,h); if(!pts||pts.length<2) return;
const mn=Math.min(...pts), mx=Math.max(...pts), r=(mx-mn)||1; c.beginPath(); for(let i=0;i<pts.length;i++){ const x=i*(w/(pts.length-1)), y=h-((pts[i]-mn)/r)*h; i?c.lineTo(x,y):c.moveTo(x,y) } c.lineWidth=1.5; c.strokeStyle='#4da3ff'; c.stroke(); }
function checkAlerts(){
let hits=0;
for(const it of state.items){
const q=state.prices[it.symbol]; if(!q) continue;
const isPct=(it.thType||'price')==='percent';
let crossed='none';
if(isPct){ const pct=q.regularMarketChangePercent, u=+it.upper, l=+it.lower;
if(!isNaN(u)&&pct>=u) crossed='upper'; else if(!isNaN(l)&&pct<=l) crossed='lower';
} else { const p=q.regularMarketPrice, u=+it.upper, l=+it.lower;
if(!isNaN(u)&&p>=u) crossed='upper'; else if(!isNaN(l)&&p<=l) crossed='lower';
}
if(crossed!=='none'){ hits++; const prev=q._prev||'none'; if(prev!==crossed){ fire(it.symbol,q,crossed,it) } q._prev=crossed }
}
el.kAlerts.textContent=hits;
}
function fire(sym,q,type,it){
try{ el.beep.currentTime=0; el.beep.play().catch(()=>{}) }catch{}
const isPct=it.thType==='percent';
const body= type==='upper'
? (isPct?`השינוי ${fmt(q.regularMarketChangePercent,2)}% מעל ${it.upper}%`:`המחיר ${fmt(q.regularMarketPrice)} מעל ${it.upper}`)
: (isPct?`השינוי ${fmt(q.regularMarketChangePercent,2)}% מתחת ${it.lower}%`:`המחיר ${fmt(q.regularMarketPrice)} מתחת ${it.lower}`);
if('Notification'in window && Notification.permission==='granted') new Notification(`התראה ${sym}`,{body}); else toast(`התראה ${sym} - ${body}`);
}

// ============ UI ============
function render(){
el.tbody.innerHTML='';
const term=el.s.value.trim().toLowerCase();
for(const it of state.items){
const det=state.details[it.symbol], sum=(det?.profile?.longBusinessSummary||'').toLowerCase();
if(term && !(it.symbol.toLowerCase().includes(term) || (it.name||'').toLowerCase().includes(term) || sum.includes(term))) continue;

const q=state.prices[it.symbol]||{};
const ch=(q.regularMarketChangePercent||0)>=0?'pos':'neg';
const st = (()=>{ if(!isFinite(q.regularMarketPrice)) return {c:'',t:'ממתין'}; const isPct=(it.thType||'price')==='percent';
if(isPct){ const pct=q.regularMarketChangePercent, u=+it.upper, l=+it.lower;
if(!isNaN(u)&&pct>=u) return {c:'bad',t:'אחוז מעל'};
if(!isNaN(l)&&pct<=l) return {c:'warn',t:'אחוז מתחת'}; return {c:'ok',t:'בטווח'};
} else { const p=q.regularMarketPrice, u=+it.upper, l=+it.lower;
if(!isNaN(u)&&p>=u) return {c:'bad',t:'חצה עליון'};
if(!isNaN(l)&&p<=l) return {c:'warn',t:'חצה תחתון'}; return {c:'ok',t:'בטווח'}; } })();

const tr=document.createElement('tr');
tr.innerHTML=`
<td><a href="https://finance.yahoo.com/quote/${it.symbol}" target="_blank" rel="noopener">${it.symbol}</a></td>
<td class="nameCell" data-sym="${it.symbol}" title="לחץ לפירוט">${it.name || it.symbol}</td>
<td>${fmt(q.regularMarketPrice)}</td>
<td class="chg ${ch}">${fmt(q.regularMarketChange)} (${fmt(q.regularMarketChangePercent,2)}%)</td>
<td>${cap(q.marketCap)}</td>
<td class="status ${st.c}">${st.t}</td>
<td><textarea data-bind="note" data-sym="${it.symbol}" class="hint">${it.note||''}</textarea></td>
<td><canvas class="spark" width="140" height="36" data-sym="${it.symbol}"></canvas></td>
<td class="row-actions">
<button data-act="save" data-sym="${it.symbol}">שמור</button>
<button data-act="del" data-sym="${it.symbol}">מחק</button>
<button data-act="info" data-sym="${it.symbol}">מידע</button>
</td>`;
el.tbody.appendChild(tr);
drawSpark(tr.querySelector('canvas.spark'), state.spark[it.symbol]||[]);
tr.addEventListener('click',e=>{
if(e.target.closest('button,textarea,a')) return;
openDrawer(it.symbol);
});
}
el.kCount.textContent=state.items.length;
el.kLastOk.textContent = lastOk || '-';
el.kStatus.textContent = lastErr ? 'שגיאת בקשות: '+lastErr : 'תקין';
}

function openDrawer(sym){
const q=state.prices[sym]||{}, d=state.details[sym]||{};
el.dTitle.textContent = `${sym} — ${(state.items.find(x=>x.symbol===sym)?.name || '')}`;
el.dBadges.innerHTML = `
<span class="chip">מחיר ${fmt(q.regularMarketPrice)}</span>
<span class="chip">% שינוי ${fmt(q.regularMarketChangePercent,2)}</span>
`;
el.dSummary.innerHTML = esc(d.profile?.longBusinessSummary)||'אין תקציר';
el.dProfile.innerHTML = `
<div>סקטור: <b>${d.profile?.sector||'-'}</b></div>
<div>תעשייה: <b>${d.profile?.industry||'-'}</b></div>
<div>שווי שוק: <b>${cap(state.prices[sym]?.marketCap)||'-'}</b></div>
<div>בטא: <b>${d.stats?.beta!=null?fmt(d.stats.beta,2):'-'}</b></div>
`;
el.dFinancials.innerHTML = `
<div>PE נוכחי: <b>${d.stats?.trailingPE!=null?fmt(d.stats.trailingPE,2):'-'}</b></div>
<div>PE עתידי: <b>${d.stats?.forwardPE!=null?fmt(d.stats.forwardPE,2):'-'}</b></div>
<div>EPS: <b>${d.earn?.lastQ?.actual!=null?fmt(d.earn.lastQ.actual,2):'-'}</b></div>
<div>תשואת דיבידנד: <b>${d.fin?.dividendYield!=null?fmt(d.fin.dividendYield*100,2)+'%':'-'}</b></div>
<div>מחיר יעד אנליסטים: <b>${d.fin?.analystTarget!=null?fmt(d.fin.analystTarget,2):'-'}</b></div>
<div>הכנסות TTM: <b>${d.fin?.totalRevenue?fmt(d.fin.totalRevenue,0):'-'}</b></div>
`;
el.dEarnings.innerHTML = `
<div>רבעון אחרון: <b>${d.earn?.lastQ?.date||'-'}</b></div>
`;
el.drawer.classList.add('open');
}
el.dClose.addEventListener('click',()=>el.drawer.classList.remove('open'));

// ============ אירועים ============
function upsert(sym,name,note,upper,lower,th){
sym=(sym||'').trim().toUpperCase(); if(!sym) return;
name=(name||'').toUpperCase();
const i=state.items.findIndex(x=>x.symbol===sym);
const base={symbol:sym,name, note:note||'', upper:upper||'', lower:lower||'', thType:th||'price'};
if(i>=0) state.items[i]={...state.items[i],...base}; else state.items.push(base);
save(); render(); fetchPrices([sym]); fetchOverview([sym]);
}
el.add.addEventListener('click',()=>{
const syms=el.sym.value.split(',').map(s=>s.trim()).filter(Boolean);
for(const s of syms) upsert(s, el.name.value, el.note.value, el.upper.value, el.lower.value, el.th.value);
el.sym.value=''; el.name.value=''; el.note.value=''; el.upper.value=''; el.lower.value='';
});
el.tbody.addEventListener('click',e=>{
const b=e.target.closest('button'); if(!b) return;
const sym=b.getAttribute('data-sym'); const act=b.getAttribute('data-act');
if(act==='del'){ if(confirm(`למחוק את ${sym}?`)){ state.items=state.items.filter(x=>x.symbol!==sym); save(); render(); } return }
if(act==='save'){ const tr=b.closest('tr'); const it=state.items.find(x=>x.symbol===sym);
it.note=tr.querySelector('textarea[data-bind="note"]').value; save(); toast('נשמר'); return }
if(act==='info'){ openDrawer(sym); fetchOverview([sym]) }
});
el.s.addEventListener('input', render);
el.sort.addEventListener('click',()=>{
state.items.sort((a,b)=>{const qa=state.prices[a.symbol]?.regularMarketChangePercent??-1e9; const qb=state.prices[b.symbol]?.regularMarketChangePercent??-1e9; return qb-qa});
render();
});
el.refresh.addEventListener('click', async()=>{
const ok=await fetchPrices();
if(ok){ lastErr=null; el.kStatus.textContent='תקין' } else { el.kStatus.textContent='שגיאת בקשות' }
fetchOverview();
render(); checkAlerts();
});
el.apply.addEventListener('click',()=>{
const n=Math.max(5, parseInt(el.interval.value||'10',10));
REFRESH=n*1000; clearInterval(timer);
timer=setInterval(tick, REFRESH);
toast('תדירות עודכנה ל '+n+' שניות');
});
el.exportBtn.addEventListener('click',()=>{
const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='watchlist_backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
el.importFile.addEventListener('change', async e=>{
const f=e.target.files?.[0]; if(!f) return;
try{ const t=await f.text(); const j=JSON.parse(t); if(!j.items) throw 0; state=j; save(); render(); }catch{ toast('יבוא נכשל') } e.target.value='';
});
el.notify.addEventListener('click', async()=>{
if(!('Notification'in window)){toast('אין תמיכה בהתראות'); return}
const p=await Notification.requestPermission(); if(p==='granted'){ el.notify.textContent='התרעות הופעלו'; el.notify.disabled=true; toast('התרעות הופעלו') }
});

// שמירת מפתח AV מהשדה
el.avKey.value = localStorage.getItem(LS_AV)||'';
el.avKey.addEventListener('change',()=>localStorage.setItem(LS_AV, el.avKey.value.trim()));

// ============ מחזוריות ============
async function tick(){
const ok=await fetchPrices();
if(ok){ lastErr=null; el.kStatus.textContent='תקין' }
fetchOverview();
render(); checkAlerts();
}

// init
render();
if(state.items.length) { tick() }
timer=setInterval(tick, REFRESH);
})();
</script>
</body>
</html>
