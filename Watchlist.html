<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>רשימת מעקב מניות</title>
<style>
  :root{
    --bg: #0b1016; --panel:#111824; --text:#e6eef6; --muted:#8aa0b5;
    --primary:#4cc2ff; --danger:#ff5d6c; --success:#3fd080; --warn:#ffb347;
    --border:#243041; --chip:#1b2633; --row-hover:#0f1620; --accent:#7dd3fc;
    --font: Inter, "Segoe UI", "Noto Sans Hebrew", Arial, sans-serif;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f7f9fc; --panel:#ffffff; --text:#0b2239; --muted:#5b7083;
      --primary:#0078d4; --danger:#c5221f; --success:#0f9d58; --warn:#b7791f;
      --border:#e6eef6; --chip:#f2f6fb; --row-hover:#f6f9ff; --accent:#0078d4;
    }
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);line-height:1.45}
  .app{max-width:1200px;margin-inline:auto;padding:16px;display:grid;gap:16px;grid-template-rows:auto auto 1fr auto}
  header{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;display:grid;gap:12px}
  header .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  h1{font-size:clamp(18px,2.4vw,24px);margin:0}
  .pill{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{
    font:inherit;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--text);
    padding:8px 10px;outline:none
  }
  input::placeholder, textarea::placeholder{color:var(--muted)}
  button{cursor:pointer;background:var(--chip)}
  button.primary{background:var(--primary);color:#001827;border:0}
  button.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
  button.danger{background:var(--danger);border:0;color:white}
  button.warn{background:var(--warn);border:0;color:#1a1200}
  .grid{display:grid;gap:8px;grid-template-columns:repeat(12,1fr);align-items:end}
  .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  @media (max-width:900px){.col-3,.col-4,.col-5,.col-6{grid-column:span 12}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .status-dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--success)} .bad{background:var(--danger)} .warnc{background:var(--warn)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .table-wrap{overflow:auto;overscroll-behavior:contain;border-radius:12px;border:1px solid var(--border)}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px;background:var(--panel)}
  thead th{position:sticky;top:0;background:var(--panel);z-index:1;border-bottom:1px solid var(--border)}
  th, td{padding:8px 10px;text-align:right;border-bottom:1px solid var(--border);white-space:nowrap}
  tbody tr:hover{background:var(--row-hover)}
  .mono{font-variant-numeric:tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .muted{color:var(--muted)}
  .right{margin-inline-start:auto}
  .chip{background:var(--chip);border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
  .gain{color:var(--success)} .loss{color:var(--danger)}
  .note{max-width:280px;overflow:hidden;text-overflow:ellipsis}
  .spark{width:100px;height:28px}
  .flex{display:flex;gap:8px;align-items:center}
  .stack{display:flex;flex-direction:column;gap:6px}
  .toast{position:fixed;inset-inline-end:16px;bottom:16px;display:grid;gap:8px;z-index:9999}
  .toast .item{background:var(--panel);border:1px solid var(--border);border-inline-start:4px solid var(--warn);padding:10px;border-radius:10px}
  dialog{border:1px solid var(--border);border-radius:12px;background:var(--panel);color:var(--text);padding:0;max-width:min(900px,96vw)}
  dialog::backdrop{background:#0006}
  .modal-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center}
  .modal-body{padding:12px 16px;display:grid;gap:12px}
  .section h3{margin:0 0 6px 0;font-size:16px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:var(--chip);border:1px solid var(--border);border-radius:6px;padding:1px 6px}
  .danger-text{color:var(--danger)}
  .wrap{white-space:normal}
</style>
</head>
<body>
<div class="app">
  <header class="panel" id="top">
    <div class="row">
      <h1>רשימת מעקב מניות</h1>
      <span class="pill">סטטוס מערכת: <span id="sysStatus">בהמתנה למפתח…</span></span>
      <span class="pill">סה״כ מניות: <b id="countTotal">0</b></span>
      <span class="pill">חציות פעילות: <b id="countAlerts">0</b></span>
      <span class="pill" id="rateInfo">קצב רענון: <b id="refreshLabel">15s</b></span>
      <span class="pill">זמן עדכון אחרון: <b id="lastUpdate">—</b></span>
      <span class="pill">תקציב יומי: <b id="dailyUsed">0</b>/<b id="dailyCap">500</b></span>
    </div>
    <div class="grid">
      <div class="col-3 stack">
        <label for="apiKey">מפתח API (Alpha Vantage)</label>
        <input id="apiKey" type="password" placeholder="הדבק כאן את המפתח" />
      </div>
      <div class="col-2 stack">
        <label for="refreshSec">תדירות (שניות)</label>
        <input id="refreshSec" type="number" min="15" max="3600" value="15"/>
      </div>
      <div class="col-3 stack">
        <label>הגדרות רענון והתראות</label>
        <div class="toolbar">
          <button id="btnTest" class="primary">בדיקת API</button>
          <button id="btnStart">התחל רענון</button>
          <button id="btnStop">עצור</button>
          <label title="עמידה במכסת 500/יום (Free). בטל אם יש לך מנוי פרימיום.">
            <input id="strictBudget" type="checkbox" checked> Strict daily budget
          </label>
          <label title="כמות קריאות מקסימלית ליום (הצעה: 480 להשאיר מרווח).">
            תקציב/יום: <input id="dailyBudget" type="number" min="50" max="100000" value="500" style="width:90px">
          </label>
        </div>
      </div>
      <div class="col-4 stack">
        <label>התראות</label>
        <div class="toolbar">
          <label title="התראות דפדפן (פוש)">
            <input id="notifyDesktop" type="checkbox" checked> פוש דסקטופ
          </label>
          <label title="צליל קצר בעת התראה">
            <input id="notifySound" type="checkbox" checked> צליל
          </label>
          <label title="אל תפריע בין שעות אלו">
            אל תפריע: מ- <input id="dndFrom" type="number" min="0" max="23" value="22" style="width:60px"> עד <input id="dndTo" type="number" min="0" max="23" value="7" style="width:60px">
          </label>
          <button id="btnClearAlerts" class="ghost">נקה התראות</button>
        </div>
      </div>
    </div>
  </header>

  <section class="panel">
    <h2 style="margin:0 0 8px 0;font-size:18px">הוספת מניה</h2>
    <div class="grid">
      <div class="col-2 stack">
        <label for="sym">סימול (AAPL, MSFT…)</label>
        <input id="sym" placeholder="AAPL" />
      </div>
      <div class="col-3 stack">
        <label for="friendly">שם ידידותי</label>
        <input id="friendly" placeholder="Apple Inc." />
      </div>
      <div class="col-3 stack">
        <label for="note">הערה</label>
        <input id="note" placeholder="לונג, דוח רבעוני בקרוב…" />
      </div>
      <div class="col-2 stack">
        <label for="thrType">סוג סף</label>
        <select id="thrType">
          <option value="price">מחיר</option>
          <option value="pct">אחוז יומי</option>
        </select>
      </div>
      <div class="col-1 stack">
        <label for="thrUpper">סף עליון</label>
        <input id="thrUpper" type="number" step="0.01" placeholder="—" />
      </div>
      <div class="col-1 stack">
        <label for="thrLower">סף תחתון</label>
        <input id="thrLower" type="number" step="0.01" placeholder="—" />
      </div>
      <div class="col-12">
        <button id="btnAdd" class="primary">הוסף לרשימה</button>
        <button id="btnExport">ייצוא רשימת מניות</button>
        <label class="ghost">
          <input id="fileImport" type="file" accept="application/json" hidden>
          <span class="kbd">ייבוא רשימת מניות</span>
        </label>
      </div>
    </div>
  </section>

  <section class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>סימול</th>
          <th>שם</th>
          <th>מחיר</th>
          <th>שינוי</th>
          <th>סטטוס/התראות</th>
          <th>בתוך האזור</th>
          <th>הערות</th>
          <th>מיני גרף</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <section class="panel">
    <div class="status-row">
      <div class="status-dot ok" id="dotOK" title="תקין" style="display:none"></div>
      <div class="status-dot warnc" id="dotWARN" title="הזהרה" style="display:none"></div>
      <div class="status-dot bad" id="dotBAD" title="שגיאה" style="display:none"></div>
      <span id="statusText" class="muted">מוכן</span>
      <span class="right muted">טיפ: פרטי חברה נטענים לפי דרישה (OVERVIEW) – חוסך קריאות API.</span>
    </div>
  </section>

  <dialog id="dlg">
    <div class="modal-head">
      <strong id="dlgTitle">פרטים</strong>
      <span id="dlgSub" class="muted"></span>
      <button id="dlgClose" class="right">✕</button>
    </div>
    <div class="modal-body">
      <div class="section">
        <h3>תקציר חברה</h3>
        <div id="ovw" class="wrap muted">—</div>
      </div>
      <div class="section">
        <h3>פרופיל</h3>
        <div id="prof" class="wrap">—</div>
      </div>
      <div class="section">
        <h3>מכפילים ונתונים</h3>
        <div id="ratios" class="wrap">—</div>
      </div>
      <div class="section">
        <h3>דוחות ותחזיות</h3>
        <div id="fund" class="wrap">—</div>
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>
</div>

<script>
/*** ====== שמירה מקומית + ברירות מחדל ====== ***/
const STORAGE_KEY = 'watchlist.v3';
const DEFAULTS = {
  settings:{
    apiKey:'', refreshSec:15,
    strictBudget:true, dailyBudget:500,
    notifyDesktop:true, notifySound:true, dndFrom:22, dndTo:7
  },
  usage:{ date: '', count: 0 }, // ספירת קריאות יומית (לפי לקוח)
  items:{}, // symbol -> {name,note,thrType,thrUpper,thrLower,last,spark,seenAlertsTs,zoneStats:{insideMs,totalMs,lastTs},nextDueTs}
  alerts:[]
};
const db = load();
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(DEFAULTS);
    const parsed = JSON.parse(raw);
    parsed.settings ||= DEFAULTS.settings;
    parsed.usage ||= DEFAULTS.usage;
    parsed.items ||= {};
    parsed.alerts ||= [];
    return parsed;
  }catch(e){ console.error(e); return structuredClone(DEFAULTS); }
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

/*** ====== עזרי UI ====== ***/
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const fmt = new Intl.NumberFormat('he-IL',{maximumFractionDigits:2});
const fmtPct = v => (v>0?'+':'') + (isFinite(v)?v.toFixed(2):'0.00')+'%';
function toast(msg, tone='warn'){
  const box = $('#toast');
  const el = document.createElement('div');
  el.className = 'item';
  el.style.borderInlineStartColor = tone==='ok'?'var(--success)':tone==='err'?'var(--danger)':'var(--warn)';
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 4500);
}
function escapeHtml(s){ return s?.replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])) || ''; }

/*** ====== התראות: דסקטופ + צליל + DND ====== ***/
function isDND(){
  const from = parseInt($('#dndFrom').value,10), to = parseInt($('#dndTo').value,10);
  const h = new Date().getHours();
  return from < to ? (h>=from && h<to) : (h>=from || h<to);
}
function requestNotifPermission(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') Notification.requestPermission();
}
function playBeep(){
  if(!db.settings.notifySound) return;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value=880; g.gain.value=0.0001;
    o.connect(g); g.connect(ctx.destination);
    o.start(); const now=ctx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.05, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.00001, now+0.25);
    o.stop(now+0.3);
  }catch(e){ /* no-op */ }
}
function notifyUser(title, body){
  if(db.settings.notifyDesktop && !isDND() && 'Notification' in window){
    if(Notification.permission==='granted'){
      new Notification(title, {body});
    }else if(Notification.permission==='default'){
      Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title,{body}); });
    }
  }
  if(!isDND() && db.settings.notifySound) playBeep();
}

/*** ====== ניהול מגבלות: דקה/יום ====== ***/
function resetDailyUsageIfNeeded(){
  const today = new Date().toISOString().slice(0,10);
  if(db.usage.date !== today){
    db.usage.date = today; db.usage.count = 0; save();
  }
}
function incDailyUsage(){
  resetDailyUsageIfNeeded();
  db.usage.count++; save(); updateUsagePill();
}
function getDailyBudget(){ return parseInt($('#dailyBudget').value||'500',10); }
function updateUsagePill(){
  $('#dailyUsed').textContent = db.usage.count;
  $('#dailyCap').textContent = db.settings.dailyBudget||500;
}
function calcSymbolIntervalSec(){
  const S = Math.max(1, Object.keys(db.items).length);
  const B = Math.max(1, db.settings.dailyBudget||500);
  const perSymbolCalls = Math.max(1, Math.floor(B / S)); // כמה מותר ליום לכל סימול
  const intervalFromBudget = Math.ceil(86400 / perSymbolCalls);
  return db.settings.strictBudget ? Math.max(db.settings.refreshSec, intervalFromBudget)
                                  : db.settings.refreshSec;
}

/*** ====== תור קריאות API לכיבוד קצב (≈5 לדקה בחינם) ====== ***/
const API = (()=> {
  let key = db.settings.apiKey || '';
  let queue = Promise.resolve();
  let lastCallTs = 0;
  const MIN_SPACING_MS = 12_500; // ~5 לדקה (Free)

  function setKey(k){ key = (k||'').trim(); db.settings.apiKey = key; save(); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function request(params){
    if(!key) throw new Error('אין מפתח API');
    // תקציב יומי מקומי
    resetDailyUsageIfNeeded();
    if(db.settings.strictBudget && db.usage.count >= (db.settings.dailyBudget||500)){
      throw new Error('ניצלת את התקציב היומי המקומי – השהיה');
    }
    const url = new URL('https://www.alphavantage.co/query');
    Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
    url.searchParams.set('apikey', key);
    const res = await fetch(url, {cache:'no-store'});
    const data = await res.json();
    // הודעות מגבלת קצב/מכסה מהשרת
    if(data?.Note){ throw new Error(data.Note); }
    if(data?.Information){ throw new Error(data.Information); }
    if(data?.['Error Message']){ throw new Error(data['Error Message']); }
    incDailyUsage(); // נספר רק על הצלחה
    return data;
  }

  function schedule(fn){
    queue = queue.then(async ()=>{
      const now = Date.now();
      const wait = Math.max(0, MIN_SPACING_MS - (now - lastCallTs));
      if(wait>0) await sleep(wait);
      const out = await fn();
      lastCallTs = Date.now();
      return out;
    }).catch(e=>{ console.error(e); });
    return queue;
  }

  // נקודות קצה עיקריות (ע"פ תיעוד רשמי של Alpha Vantage)
  const globalQuote = (symbol)=> schedule(()=>request({function:'GLOBAL_QUOTE', symbol}));
  const overview    = (symbol)=> schedule(()=>request({function:'OVERVIEW', symbol}));
  const daily       = (symbol)=> schedule(()=>request({function:'TIME_SERIES_DAILY', symbol, outputsize:'compact'}));
  return { setKey, globalQuote, overview, daily, sleep };
})();

/*** ====== רינדור טבלה ====== ***/
function render(){
  const tbody = $('#tbody'); tbody.innerHTML = '';
  const symbols = Object.keys(db.items).sort();
  $('#countTotal').textContent = symbols.length;
  let activeCross = 0;

  for(const sym of symbols){
    const it = db.items[sym];
    const price = it.last?.price ?? null;
    const chg = it.last?.changePct ?? null;
    const statusChips = [];
    if(it.last?.cross?.length){ activeCross += it.last.cross.length; statusChips.push(...it.last.cross.map(c=>`<span class="chip">${c}</span>`)); }

    const insideRatio = computeInsideRatio(sym);
    const insideText = isNaN(insideRatio) ? '<span class="muted">—</span>' : (insideRatio*100).toFixed(0)+'%';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono"><strong>${sym}</strong></td>
      <td class="wrap">${escapeHtml(it.name||'')}</td>
      <td class="mono">${price!=null ? fmt.format(price) : '<span class="muted">—</span>'}</td>
      <td class="mono ${chg!=null?(chg>=0?'gain':'loss'):''}">${chg!=null?fmtPct(chg):'<span class="muted">—</span>'}</td>
      <td>${statusChips.join(' ') || '<span class="muted">—</span>'}</td>
      <td><span class="chip">${insideText}</span></td>
      <td class="note">${escapeHtml(it.note||'')}</td>
      <td><canvas class="spark" data-sym="${sym}"></canvas></td>
      <td class="flex">
        <button data-act="details" data-sym="${sym}">פרטים</button>
        <button data-act="refresh" data-sym="${sym}">רענן</button>
        <button data-act="delete" data-sym="${sym}" class="danger">מחק</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  $('#countAlerts').textContent = activeCross;
  $('#refreshLabel').textContent = (db.settings.refreshSec||15)+'s';
  updateUsagePill();
  drawSparks().catch(()=>{});
}

function computeInsideRatio(sym){
  const z = db.items[sym]?.zoneStats;
  if(!z || z.totalMs<=0) return NaN;
  return Math.max(0, Math.min(1, z.insideMs / z.totalMs));
}

/*** ====== ספארקליין ====== ***/
async function drawSparks(){
  const canvases = $$('#tbody .spark');
  for(const c of canvases){
    const sym = c.dataset.sym;
    const it = db.items[sym];
    if(!it.spark || Date.now() - (it.spark.ts||0) > 60*60*1000){ // שעה
      try{
        const d = await API.daily(sym); // TIME_SERIES_DAILY (compact)
        const ts = d['Time Series (Daily)'] || {};
        const closes = Object.keys(ts).slice(0,60).reverse().map(k=> parseFloat(ts[k]['4. close']));
        it.spark = { ts: Date.now(), closes };
        save();
      }catch(e){ console.warn('spark fail', sym, e.message); }
    }
    if(it.spark?.closes?.length>1) paintSpark(c, it.spark.closes);
  }
}
function paintSpark(canvas, arr){
  const w=canvas.width=canvas.clientWidth, h=canvas.height=canvas.clientHeight;
  const min=Math.min(...arr), max=Math.max(...arr);
  const pad=2, xs= (w-2*pad)/(arr.length-1), scale = (v)=> h - pad - ((v-min)/(max-min||1))*(h-2*pad);
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#4cc2ff';
  ctx.lineWidth=1.5;
  ctx.beginPath();
  arr.forEach((v,i)=>{ const x=pad+ i*xs, y=scale(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();
}

/*** ====== הוספה/מחיקה/עדכון ====== ***/
function addItem(){
  const sym = ($('#sym').value||'').trim().toUpperCase();
  if(!sym) return toast('יש להזין סימול','err');
  if(db.items[sym]) return toast('הסימול כבר ברשימה','warn');
  const now = Date.now();
  db.items[sym] = {
    name: ($('#friendly').value||'').trim(),
    note: ($('#note').value||'').trim(),
    thrType: $('#thrType').value,
    thrUpper: numOrNull($('#thrUpper').value),
    thrLower: numOrNull($('#thrLower').value),
    last: null, spark: null, seenAlertsTs: 0,
    zoneStats: {insideMs:0,totalMs:0,lastTs: now},
    nextDueTs: now // ייכנס לתור
  };
  save(); render();
  refreshOne(sym).then(render);
  clearAddForm();
}
function numOrNull(v){ const n = parseFloat(v); return isNaN(n)?null:n; }
function clearAddForm(){ $('#sym').value=''; $('#friendly').value=''; $('#note').value=''; $('#thrUpper').value=''; $('#thrLower').value=''; }
function delItem(sym){ delete db.items[sym]; save(); render(); }

/*** ====== עדכון נתונים (מחיר/שינוי) ====== ***/
let timer=null, tickRunning=false;
function start(){
  const sec = parseInt($('#refreshSec').value||'15',10);
  db.settings.refreshSec = Math.max(15, Math.min(3600, sec));
  db.settings.strictBudget = $('#strictBudget').checked;
  db.settings.dailyBudget = getDailyBudget();
  API.setKey($('#apiKey').value);
  save();
  if(timer) clearInterval(timer);
  tick(); // עכשיו
  timer = setInterval(tick, db.settings.refreshSec*1000);
  setStatus('רענון פעיל', 'ok');
}
function stop(){ if(timer) clearInterval(timer); timer=null; setStatus('נעצר','warn'); }

async function tick(){
  if(tickRunning) return;
  tickRunning = true;
  try{
    resetDailyUsageIfNeeded(); updateUsagePill();
    const symbols = Object.keys(db.items);
    if(!symbols.length){ render(); return; }

    const now = Date.now();
    const interval = calcSymbolIntervalSec();

    // מצא מי “מגיע תורו” לפי nextDueTs
    const due = symbols
      .map(s=>({s, due: db.items[s].nextDueTs||0}))
      .filter(o=> o.due<=now)
      .sort((a,b)=> a.due - b.due);

    if(due.length){
      const pick = due[0].s;
      await refreshOne(pick);
      // קבע מועד הבא לפי האינטרוול המחושב או 15ש׳ אם strict כבוי
      db.items[pick].nextDueTs = now + interval*1000;
      save();
    }
    $('#lastUpdate').textContent = new Date().toLocaleString('he-IL');

    // מידע שקוף למשתמש
    const cycleSec = interval; // כל סימול מתוזמן פרטנית לפי interval
    $('#rateInfo').innerHTML = `קצב רענון: <b id="refreshLabel">${db.settings.refreshSec}s</b> · יעד לסימול ≈ <b>${Math.round(cycleSec/60)} דק׳</b>`;

  } finally {
    render();
    tickRunning = false;
  }
}

async function refreshOne(sym){
  try{
    const q = await API.globalQuote(sym); // GLOBAL_QUOTE
    const g = q['Global Quote'] || {};
    const price = parseFloat(g['05. price']);
    const change = parseFloat(g['09. change']);
    const chPct = parseFloat((g['10. change percent']||'0').replace('%',''));
    const prev = db.items[sym].last?.price ?? null;
    const crossMsgs = computeCrossAndZone(sym, prev, price, chPct);
    db.items[sym].last = { price, change, changePct: chPct, cross: crossMsgs };
    save();
    setStatus('עודכן', 'ok', true);
  }catch(e){
    console.warn('quote fail', sym, e.message);
    const msg = e.message.includes('Thank you for using Alpha Vantage') ? 'מגבלת קצב בשרת – המתנה…' :
                e.message.includes('ניצלת את התקציב היומי') ? 'ניצלנו את התקציב היומי המקומי' :
                'שגיאת API';
    setStatus(msg, 'warn');
  }
}

/*** ====== לוגיקת חציות + סטטיסטיקת “בתוך האזור” ====== ***/
function computeCrossAndZone(sym, prevPrice, currPrice, currPct){
  const it = db.items[sym];
  const msgs = [];

  function zoneMsg(prevVal, currVal, lower, upper, label){
    if(lower==null || upper==null) return;
    const wasInside = prevVal!=null && prevVal>=lower && prevVal<=upper;
    const isInside  = currVal!=null && currVal>=lower && currVal<=upper;
    if(wasInside!==isInside){
      msgs.push(isInside ? `נכנס לאזור ${label} (${lower}–${upper})`
                         : `יצא מאזור ${label} (${lower}–${upper})`);
    }
    // סטטיסטיקה של זמן בתוך האזור
    const now = Date.now();
    const z = it.zoneStats ||= {insideMs:0,totalMs:0,lastTs: now};
    const dt = Math.max(0, now - (z.lastTs||now));
    if(z.lastTs){
      z.totalMs += dt;
      if(isInside) z.insideMs += dt;
    }
    z.lastTs = now;
  }

  if(it.thrType==='price'){
    const u = it.thrUpper, l = it.thrLower;
    if(u!=null && prevPrice!=null && prevPrice<=u && currPrice>u) msgs.push(`עלה מעל ${u}`);
    if(l!=null && prevPrice!=null && prevPrice>=l && currPrice<l) msgs.push(`ירד מתחת ${l}`);
    zoneMsg(prevPrice, currPrice, l, u, 'מחיר');
  } else { // pct
    const u = it.thrUpper, l = it.thrLower;
    const prevPct = it.last?.changePct ?? null;
    if(u!=null && prevPct!=null && prevPct<=u && currPct>u) msgs.push(`שינוי יומי חצה ↑ ${u}%`);
    if(l!=null && prevPct!=null && prevPct>=l && currPct<l) msgs.push(`שינוי יומי חצה ↓ ${l}%`);
    zoneMsg(prevPct, currPct, l, u, 'אחוז');
  }

  // יצירת התראות חדשות בלבד
  if(msgs.length){
    const t = Date.now();
    for(const m of msgs){
      const id = `${sym}|${m}`;
      const already = db.alerts.find(a=>a.id===id && t-a.ts<12*60*60*1000); // 12 שעות
      if(!already){
        db.alerts.push({id, sym, m, ts:t, seen:false});
        toast(`${sym}: ${m}`, 'ok');
        if(!isDND()){ notifyUser(sym, m); }
      }
    }
    save();
  }
  return msgs;
}

/*** ====== חלון פרטים ====== ***/
const dlg = $('#dlg'); $('#dlgClose').onclick=()=>dlg.close();
async function openDetails(sym){
  const it = db.items[sym];
  $('#dlgTitle').textContent = sym;
  $('#dlgSub').textContent = it.name||'';
  $('#ovw').textContent = 'טוען…';
  $('#prof').textContent = '—';
  $('#ratios').textContent = '—';
  $('#fund').textContent = '—';
  dlg.showModal();
  try{
    const o = await API.overview(sym); // OVERVIEW
    $('#ovw').textContent = o.Description || '—';
    $('#prof').innerHTML =
      `<div>ענף: <b>${escapeHtml(o.Industry||'—')}</b></div>
       <div>סקטור: <b>${escapeHtml(o.Sector||'—')}</b> | מדינה: <b>${escapeHtml(o.Country||'—')}</b></div>
       <div>אתר: ${o.Website?`<a href="${o.Website}" target="_blank" rel="noopener">${o.Website}</a>`:'—'}</div>`;
    $('#ratios').innerHTML =
      `<div>מכפיל רווח (TTM): <b>${o.TrailingPE||'—'}</b></div>
       <div>מכפיל מכירות (TTM): <b>${o.PriceToSalesRatioTTM||'—'}</b></div>
       <div>מרווח תפעולי: <b>${o.OperatingMarginTTM||'—'}</b></div>
       <div>תשואת דיבידנד: <b>${o.DividendYield||'—'}</b></div>`;
    $('#fund').innerHTML =
      `<div>שווי שוק (מוערך): <b>${o.MarketCapitalization?fmt.format(parseFloat(o.MarketCapitalization)):'—'}</b></div>
       <div>מניות מונפקות: <b>${o.SharesOutstanding?fmt.format(parseFloat(o.SharesOutstanding)):'—'}</b></div>
       <div>דוח אחרון: <b>${escapeHtml(o.LatestQuarter||'—')}</b></div>`;
    // סימון התראות כנקראו
    db.alerts.filter(a=>a.sym===sym).forEach(a=>a.seen=true);
    db.items[sym].seenAlertsTs = Date.now(); save(); render();
  }catch(e){
    $('#ovw').innerHTML = `<span class="danger-text">שגיאה בטעינת פרטים: ${escapeHtml(e.message)}</span>`;
  }
}

/*** ====== בדיקת API ומצב מערכת ====== ***/
$('#btnTest').onclick = async ()=>{
  try{
    API.setKey($('#apiKey').value);
    setStatus('בודק…','warn');
    await API.globalQuote('MSFT'); // קריאה קלה לאימות
    setStatus('חיבור תקין', 'ok');
    toast('בדיקת API עברה בהצלחה','ok');
  }catch(e){
    const isLimit = /limit|Thank you for using Alpha Vantage/i.test(e.message);
    setStatus(isLimit?'חסימת קצב/מכסה – נסה מאוחר יותר':'כשל בבדיקה', isLimit?'warn':'bad');
    toast('בדיקת API נכשלה: '+e.message,'err');
  }
};
function setStatus(txt, tone='ok', silent=false){
  $('#sysStatus').textContent = txt;
  $('#statusText').textContent = txt;
  $('#dotOK').style.display = tone==='ok'?'inline-block':'none';
  $('#dotWARN').style.display = tone==='warn'?'inline-block':'none';
  $('#dotBAD').style.display = tone==='bad'?'inline-block':'none';
  if(!silent){
    if(tone==='ok') toast(txt,'ok');
    else if(tone==='warn') toast(txt,'warn');
    else toast(txt,'err');
  }
}

/*** ====== אירועים ====== ***/
$('#btnAdd').onclick = addItem;
$('#btnStart').onclick = start;
$('#btnStop').onclick = stop;
$('#btnClearAlerts').onclick = ()=>{ db.alerts.forEach(a=>a.seen=true); save(); render(); toast('ההתראות סומנו כנקראו','ok'); };

$('#btnExport').onclick = ()=>{
  const minimal = {
    version: 1,
    items: Object.fromEntries(
      Object.entries(db.items).map(([sym, it]) => [sym, {
        name: it.name||'',
        note: it.note||'',
        thrType: it.thrType||'price',
        thrUpper: it.thrUpper ?? null,
        thrLower: it.thrLower ?? null
      }])
    )
  };
  const blob = new Blob([JSON.stringify(minimal,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='watchlist-items.json'; a.click();
  URL.revokeObjectURL(url);
};

$('#fileImport').parentElement.onclick = ()=> $('#fileImport').click();
$('#fileImport').onchange = e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const obj = JSON.parse(r.result);
      if(obj.items && typeof obj.items==='object'){
        for(const [sym, bare] of Object.entries(obj.items)){
          db.items[sym] ??= { zoneStats:{insideMs:0,totalMs:0,lastTs:Date.now()}, nextDueTs: Date.now() };
          Object.assign(db.items[sym], {
            name: bare.name||db.items[sym].name||'',
            note: bare.note||db.items[sym].note||'',
            thrType: bare.thrType||db.items[sym].thrType||'price',
            thrUpper: bare.thrUpper ?? db.items[sym].thrUpper ?? null,
            thrLower: bare.thrLower ?? db.items[sym].thrLower ?? null
          });
        }
        save(); render(); toast('ייבוא רשימת מניות הושלם','ok');
      } else {
        toast('קובץ ייבוא לא תקין (חסר items)','err');
      }
    }catch(err){ toast('קובץ לא תקין','err'); }
  };
  r.readAsText(f);
};

$('#refreshSec').onchange = ()=>{
  db.settings.refreshSec = parseInt($('#refreshSec').value||'15',10);
  save(); $('#refreshLabel').textContent = db.settings.refreshSec+'s';
};
$('#strictBudget').onchange = ()=>{ db.settings.strictBudget = $('#strictBudget').checked; save(); };
$('#dailyBudget').onchange = ()=>{ db.settings.dailyBudget = getDailyBudget(); save(); updateUsagePill(); };
$('#notifyDesktop').onchange = ()=>{ db.settings.notifyDesktop = $('#notifyDesktop').checked; save(); if(db.settings.notifyDesktop) requestNotifPermission(); };
$('#notifySound').onchange = ()=>{ db.settings.notifySound = $('#notifySound').checked; save(); };
$('#dndFrom').onchange = ()=>{ db.settings.dndFrom = parseInt($('#dndFrom').value||'22',10); save(); };
$('#dndTo').onchange   = ()=>{ db.settings.dndTo   = parseInt($('#dndTo').value||'7',10); save(); };

$('#apiKey').value = db.settings.apiKey||'';
$('#refreshSec').value = db.settings.refreshSec||15;
$('#refreshLabel').textContent = (db.settings.refreshSec||15)+'s';
$('#strictBudget').checked = db.settings.strictBudget ?? true;
$('#dailyBudget').value = db.settings.dailyBudget ?? 500;
$('#notifyDesktop').checked = db.settings.notifyDesktop ?? true;
$('#notifySound').checked = db.settings.notifySound ?? true;
$('#dndFrom').value = db.settings.dndFrom ?? 22;
$('#dndTo').value   = db.settings.dndTo   ?? 7;
updateUsagePill();
requestNotifPermission();

$('#tbody').onclick = (ev)=>{
  const btn = ev.target.closest('button'); if(!btn) return;
  const sym = btn.dataset.sym;
  const act = btn.dataset.act;
  if(act==='details') openDetails(sym);
  if(act==='delete'){ if(confirm('למחוק את '+sym+'?')) delItem(sym); }
  if(act==='refresh'){ refreshOne(sym).then(render); }
};

// רינדור ראשוני
render();
</script>
</body>
</html>
